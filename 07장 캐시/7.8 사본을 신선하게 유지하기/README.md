# 7.8 사본을 신선하게 유지하기
캐시된 데이터는 서버의 데이터와 일치하도록 관리되어야한다.
- 문서만료
- 서버재검사

## 7.8.1 문서만료
HTTP는 Cache-Control과 Expires라는 헤더를 이용하여 문서 유효기간을 설정한다.


- Expires: Fri, 05 Jul 2002, 05:00:00 GMT
- Cache-Control: max-age=484200


문서가 만료되면, 캐시는 문서에 변경된 것이 있는지 검사해야하며, 변경된 것이 있으면 사본과 새유효기간을 가져와야한다.

## 7.8.2 유효기간과 나이
Cache-Control: max - age 문서의 최대나이를 정의한다.(합법적인 최댓값, 초단위)


Expires : 절대 유효기간을 명시, 유효기간을 경과했다면, 그 문서는 신선하지 않음.

## 7.8.3 서버 재검사
캐시된 문서가 만료되었다는 것은, 서버 문서와 다르다는 것이 아니라, 검사할 시간이 되었음을 의미. 


캐시가 원 서버에세 문서가 변경되었는지의 여부를 물어 보는 것을 '서버 재검사'라고 한다.



- 재검사 결과 변경되었다면, 캐시는 그 문서의 새로운 사본을 가져와 기존 문서 대신 저장 후 클라이언트에게도 보내준다.
- 변경되지 않았다면, 캐시는 새 만료일을 포함한 새 헤더들만 가져와서 캐시 안의 헤더들을 갱신한다.


장점: 서버의 트래픽 절약, 신선하지 않은 내용 제공하지 않음, USER 응답 시간을 개선할 수 있다.


HTTP 프로토콜은 신선한 캐시된 사본 사본, 재검사 후 캐시 사본, 에러메시지, 경고 메시지가 부착된 캐시된 사본 중 하나를 반환해야한다.

## 7.8.4 조건부 메서드와의 재검사
HTTP는 캐시가 서버에세 '조건부 GET'이라는 보낼 수 있게 해준다. 문서가 다른 경우에 객체 분문을 보내달라고 하는 것.


조건부 요청 헤더
- If-Modified-Since: <date> : 주어진 날짜 이후 수정된 경우, 변경된 경우에 콘텐츠를 가져오기 위해 Last-Modified 서버 응답 헤더와 함께 사용.
- If-None-Match: <tag> : 캐시된 태그가 서버에 있는 문서의 태그와 다를 때만 처리.

## 7.8.5 If-Modified-Since : 날짜 재검사
IMS 요청으로 불림
* 문서가 주어진 날짜 이후에 변경되었다면, 조건은 참. GET요청받는다. 새로운 만료 날짜와 그 외 헤더들과 함께 캐시에 반환.
* 변경되지 않은 경우, 조건 거짓. 서버는 304 Not Modified 응답 메시지를 클라이언트에게 돌려줌, 본문은 보내지 않고 갱신이 필요한 헤더만 보내준다. (보통 새 만료 날짜)


캐시가 문서를 재검사 할 때, If-Modified-Since 헤더를 포함하여 응답한다.


If-Modified-Since: <캐시된 마지막 수정일>
- 변경되었다면, 최근 변경 일시는 다를 것이고 원 서버는 새 문서를 돌려준다.
- 변경되지 않았다면, 최근 변경 일시는 같을 것이고 304 Not Modified 응답을 돌려준다.

## 7.8.6 If-None-Match: 엔터티 태그 재검사
If-Modified-Since : 날짜 재검사가 적절히 행해지기 어려운 상황에 사용할 수 있음.
- 내용의 변화가 없는 일정시간 간격으로 다시 쓰여지는 문서. 변경시간만 바뀌는 경우
- 변화가 너무 사소한 경우
- 최근 변경 일시를 정확하게 알 수 없는 경우
- 1s보다 작은 간격으로 갱신되는 문서를 제공하는 서버들

문서가 변경했을 때, 엔터티 태그를 새로운 버전으로 표현한다.(v2.6)
- 엔티티 요청 방식 - 태그가 변경되지 않은 경우
 1) 요청 GET / If-None-Match: "v2.6"
 2) 응답 304 Not Modified / ETag : "v2.6"
- 엔티티 요청 방식 - 태그가 변경된 경우
 1) 요청 GET / If-None-Match: "v2.6"
 2) 응답 200 OK / ETag : "v3.0"

## 7.8.7 약한 검사기와 강한 검사기
- 약한 검사기 : 조금 변경된 경우, 유의미한 변경이 있을 때마다 바뀜, 서버는 'W/' 접두사를 붙여 약한 검사기를 파악한다.
- 강한 검사기 : 엔터티 값이 매번 달라야한다.

## 7.8.8 언테 엔터티 태그를 사용하고 언제 Last-Modified 일시를 사용하는가
- HTTP/1.1 클라이언트는 서버가 엔터티 태그를 반환한 경우, 엔터티 태그 검사기를 사용해야한다.


  서버가 Last-Modified 값만 반환한경우, 클라이언트는 If-Modified-Since 검사를 사용할 수 있음.
- 엔터티 태그와 If-Modified-Since 모두 사용 가능한 경우, 클라이언트는 두 가지 검사 정책을 모두 사용해야한다. 
- HTTP/1.1 원서버는 가능하다면 엔터티 태그 검사기를 보내야하며 Last-Modified 값을 같이 보내는 것도 선호됨
- HTTP/1.1 캐시나 서버가 If-Modified-Since와 엔터티 태그 조건부 헤더를 모두 받았다면, 요청의 모든 조건부 헤더 필드의 조건에 부합되지 않는 한 304 Not Modified 응답을 반환해서는 안됨.





