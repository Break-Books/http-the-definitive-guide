# 6.6 메세지 추적

프록시가 흔해지면서, 서로 다른 스위치와 라우터를 넘나드는 IP 패킷의 흐름을 추적하는 것 못지않게 프록시를 넘나드는 메시지의 흐름을 추적하고 문제점을 찾아내는 것도 필요한 일이 되었다.

## 6.6.1 Via 헤더

Via 헤더 필드는 메시지가 지나는 각 중간 노드의 정보를 나열한다.

```http
Via: 1.1 proxy-62.irenes-isp.net, 1.0 cache.joes-hardware.com
```
첫번째 프록시는 HTTP/1.1 프로토콜을 구현했고 proxy-62.irenes-isp.net라 불리며 두번째 프록시는 HTTP/1.0을 구현했고 cache.joes-hardware.com로 불린다.

+ Via 헤더 필드는 메세지 발송자들이 프로토콜을 다루는 능력을 알아보기 위해 사용된다.

+ 프록시는 네트워크의 라우팅 루프를 탐지하기 위해 Via 헤더를 사용할 수 있다.
  + 프록시는 요청을 보내기 전에 자신을 가리키는 유일한 문자열을 Via헤더에 삽입해야 하고, 루프가 있는지 탐지하기 위해 이 문자열이 들어온 요청에 있는지 검사해야 한다.

_Via 문법_

각 Via waypoint는 프로토콜 이름(선택. 기본은 HTTP), 프로토콜 버전(필수), 노드이름(필수), 코멘트(선택)의 최대 4개의 구성요소를 담을 수 있다.

+ 프로토콜 이름: HTTP라면 없어도 된다. 버전 앞에 ‘/’로 구분되어 붙는다.
+ 프로토콜 버전: 애플리케이션들은 자신 이전의 모든 중개자들이 어떤 버전을 다룰 수 있는지 알 수 있다.
+ 노드 이름: 중개자의 호스트와 포트 번호. 정보 보호를 이유로 진짜 호스트명을 밝히고싶지 않을 경우 가명으로 대체할 수 있다.
+ 노드 코멘트: 중개자 노드를 서술하는 선택적인 코멘트. 벤터나 버전 정보등을 포함할 수도 있다.


_Via 요청과 응답 경로_

요청 메세지와 응답 메세지 모두 프록시를 지나므로 둘 모두 Via 헤더를 가진다.
응답의 Via 헤더는 요청의 Via 헤더와 언제나 반대이다.

_Via와 게이트웨이_

몇몇 프록시는 서버에게 비 HTTP 프로토콜을 사용할 수 있는 게이트웨이 기능을 제공한다.

1. 클라이언트는 HTTP 요청을 게이트웨이로 보낸다.
2. 프로토콜 게이트웨이로 동작하는 프록시는 FTP 프로토콜을 이용해 FTP 서버로부터 원하는 객체를 받아온다.
3. 프록시는 그 객체를 Via 헤더 필드와 함께 클라이언트에게 HTTP 응답으로 돌려준다.

_Server 헤더와 Via 헤더_

+ Server 응답 헤더 필드는 원 서버에 의해 사용되는 소프트웨어를 알려준다.
+ 응답 메시지가 프록시를 통과할 때, 프록시는 Server 헤더를 수정해서는 안된다.

## 6.6.2 TRACE 메서드

TRACE 메서드가 필요한 이유

+ 프록시는 메시지가 전달될 때 메시지를 바꿀 수 있기 때문에 상호운용성 문제가 발생한다. 
+ 프록시 네트워크를 쉽게 진단하기 위해, 홉에서 홉으로 전달될 때마다 메시지의 내용이 어떻게 변하는지 관찰할 방법이 필요하다.

TRACE 메서드란
+ TRACE 메서드는 요청 메시지를 프록시의 연쇄를 따라가면서 어떤 프록시를 지나가고 어떻게 각 프록시가 요청 메시지를 수정하는지 관찰/추적할 수 있도록 해준다.
+ TRACE 요청이 목적지 서버에 도착했을 때, 서버는 전체 요청 메시지를 HTTP응답 메시지의 본문에 포함시켜 송신자에게 그대로 돌려보낸다.

_Max-Forwards_

+ Max-Forwards 헤더를 사용하면, 홉의 개수를 제한하여 전달되는 메시지가 무한 루프에 빠지지 않는지 테스트하거나 연쇄 중간의 특정 프록시 서버들의 효과를 체크할 수 있다.
+ Max-Forwards 요청 헤더 필드는 요청 메세지가 몇 번 더 다음 홉으로 전달될 수 있는가에 대한 정수를 담고 있다.