# 4.2 TCP 성능에 대한 고려

## 4.2.5 TCP Slow Start

TCP의 성능은 TCP의 나이에 따라서도 좌우된다.

처음에는 천천히 시작했다가 점점 속도를 올린다.

만약 하나의 패킷이 성공적으로 받아졌다면 2개의 패킷을 추가로 더 보낼 수 있게 된다. 점점 보낼 수 있는 패킷의 수를 늘려간다. 이를 'opening the congestion window'라고 표현한다.

따라서 새로운 커넥션은 기존에 있던 커넥션보다 느리다. 따라서 HTTP는 기존에 존재하던 connection을 재사용하는 편의성 기능을 제공한다.

후에 'persistent connections (지속 커넥션)'에 대해서 더 자세하게 이야기한다.

## 4.2.6 Nagle의 알고리즘과 TCP_NODELAY

TCP 세그먼트 하나 당 40 byte의 플래그와 헤더 데이터가 추가되기 때문에, 적은 양의 데이터를 담은 많은 양의 패킷을 보내면 성능이 저하된다.

네이글 알고리즘은 패킷을 보내기 전에 많은 양의 데이터를 번들링해서 네트워크 효율을 올린다.

RFC896, "Congestion Control in IP/TCP Internetworks" 라는 곳에서 발견할 수 있다.

네이글 알고리즘은 세그먼트가 full size (수백 바이트에서 1500 바이트)가 아니면 보내는 것을 지양한다.

오직 acknowledge 되었을 때만 non-full-size packet을 보내는 것을 허용한다.

만약 다른 패킷이 여전히 보내지고 잇다면, partial data는 버퍼시킨다. 이 버퍼된 데이터는 오직 pending packet들이 awk되고 버퍼가 충분히 많은 데이터를 쌓았을 경우에만 보내진다.

> 추가적인 공부가 필요하다.

네이글 알고리즘은 성능 문제를 야기시킨다.

1. 작은 HTTP 메세지들이 패킷을 다 못 채울 수도 있어서 전송이 지연될 수도 있다.
2. disabled acknowledgement와의 연동이 좋지 않다.

다양한 이유 때문에 HTTP application들은 Nagle 알고리즘을 disable시킨다.

TCP_NODELAY 파라미터를 설정하면 된다. 이 경우 스스로 한번에 많은 데이터를 보내도록 노력해야 한다.

## 4.2.7 TIME_WAIT Accumulation과 Port Exhausion

TIME_WAIT은 벤치마킹을 할 때 심각한 성능 문제를 야기한다. 벤치마킹을 할 일이 있을 경우 이를 조심해야 한다.

TCP endpoint가 TCP 연결을 닫으면 메모리에 IP 주소와 포트 넘버를 기입한 작은 컨트롤 블록을 유지한다.
이 정보는 2MSL 동안 유지된다.

2MSL: twice the estimated maximum segment lifetime

보통 2분 정도이다.

그 시간 동안 같은 주소와 포트를 통한 TCP 연결을 만들지 않으려고 이러는 것이다.

떠도는 duplicate packet이 같은 주소와 포트를 통해 만들어진 새로운 커넥션에 실수로 잘못 주입되는 것을 막기 위함이다.

이 알고리즘을 통해 2분 안에 새로운 주소와 포트를 통해 새로운 연결이 만들어지는 것을 막을 수 있다.

요즘은 라우터가 빨라서 duplicate packet이 2분 후에 도착하는 일이 극히 드물다. 어떤 운영체제는 2MSL을 2분이 아니라 더 작은 값으로 바꿔두기도 하지만 주의하자!

근데 2MSL은 벤치마킹을 할 때 문제를 야기할 수 있다.

오직 한 대 혹은 몇 대의 테스트 컴퓨터만 벤치마크에 사용되므로, 서버에 연결될 때 계속 IP와 포트가 중복되어 2분 내에 만들 수 있는 커넥션의 갯수가 제한된다.

심지어, 서버는 보통 HTTP 용 포트 80만 사용한다.

2분 동안 사용할 수 있는 포트의 개수가 60000개 이하일 것이므로, 아무리 많아봤자 1초에 500개 정도밖에 만들 수 없다.

따라서 벤치마킹에서는 1초에 500개 이상의 transaction을 할 수 없는 것이다!!!

> 정말 좋은 정보를 배웠다.
