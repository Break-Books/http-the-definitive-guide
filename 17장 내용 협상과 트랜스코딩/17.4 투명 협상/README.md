# 17.4 투명 협상

**투명 협상**: 서버에서의 협상 부담을 줄이기 위해 중계 프록시를 활용하여 클라이언트 대신에 협상을 수행하는 것을 목표한다.

- 프락시는  클라이언트의 기대를 알고 협상을 수행할 수 있는 것으로 가정한다.
- 서버는 클라이언트 요청을 가장 잘 맞추기 위해 어떤 요청 헤더를 검사하는지를 프록시에게 알려야 한다.
- HTTP/1.1 명세는 투명 협상을 정의하지 않지만, Vary 헤더를 사용하여 서버가 어떤 요청 헤더를 사용하는지 중계 프록시에게 알린다.

**캐싱 프록시:** 단일 URL을 통해 액세스된 문서의 다른 복사본을 저장할 수 있으며, 서버가 캐시에게 결정 과정을 전달하면 캐시는 클라이언트와 협상할 수 있다.

- 캐시는 콘텐츠 변환을 수행하기에 적합하며, 일반적인 목적의 트랜스코더는 특정 서버뿐만 아니라 어떤 서버에서든 콘텐츠를 변환할 수 있다.

## 17.4.1 캐시와 얼터네이트(alterante)

**콘텐츠 캐싱**: 해당 콘텐츠가 나중에 **재사용**될 것이라고 가정한다.

→ 캐시는 서버가 응답을 보낼 때와 유사한 결정 로직을 사용하여 올바른 캐시 응답을 클라이언트 요청에 다시 보내야 한다.

**얼터네이트/배리언트**: 같은 URL에 대한 다른 응답들을 모두 저장함으로써 가지게 되는 다른 버전의 문서.

⇒ **내용 협상** = 배리언트 중 클라이언트 요청에 가잘 잘 맞는 것을 선택하는 과정.

## 17.4.2 Vary 헤더

만약 서버의 결정이 Accept 헤더가 아닌 다른 헤더(예: User-Agent)를 기반으로 한 경우, 캐시는 이 헤더를 고려하여 어떤 캐시된 응답을 클라이언트에 다시 보낼지 결정해야 한다.

이때, HTTP Vary 헤더는 서버가 고려하는 클라이언트 요청 헤더를 명시한다.

클라이언트의 새로운 요청이 도착하면 캐시는 콘텐츠 협상 헤더를 사용하여 최적의 캐시 응답을 찾고, 그 후에 Vary 헤더를 확인하여 일치 여부를 검사한다.

서버의 Vary 헤더에 따라 다양한 클라이언트 헤더 값에 대응하는 모든 캐시 변형을 저장해야 한다.